---
description: State management, data fetching, and caching patterns for SpaceBooker
globs:
  - "**/*.{ts,tsx}"
  - "**/hooks/**"
  - "**/api/**"
---

# SpaceBooker - State Management

> **REFERENCE ONLY**: This is a filled-in example showing the expected format.
> To create your own file, use `../../templates/cursor-rules/state-management.mdc`.
> Do NOT copy this content directly - adapt the STRUCTURE, not the CONTENT.

---

## State Categories

| Category | Tool | Use For |
|----------|------|---------|
| **Server State** | React Query | Spaces, Bookings, Users |
| **Client State** | Zustand | Sidebar, Modals, Theme |
| **URL State** | Next.js router | Filters, Pagination, Search |
| **Form State** | React Hook Form | Booking form, Profile form |

---

## Server State (React Query)

### Spaces Queries

```typescript
import { useQuery } from '@tanstack/react-query'
import { spaceKeys } from '@/lib/query-keys'

export function useSpaces(filters?: SpaceFilters) {
  return useQuery({
    queryKey: spaceKeys.list(filters),
    queryFn: () => api.getSpaces(filters),
    staleTime: 5 * 60 * 1000, // 5 minutes - spaces don't change often
  })
}

export function useSpace(spaceId: string) {
  return useQuery({
    queryKey: spaceKeys.detail(spaceId),
    queryFn: () => api.getSpace(spaceId),
    enabled: !!spaceId,
  })
}
```

### Bookings Queries

```typescript
export function useBookings(userId: string, filters?: BookingFilters) {
  return useQuery({
    queryKey: bookingKeys.list(userId, filters),
    queryFn: () => api.getBookings(userId, filters),
    staleTime: 1 * 60 * 1000, // 1 minute - bookings change more often
  })
}

export function useBookingDetail(bookingId: string) {
  return useQuery({
    queryKey: bookingKeys.detail(bookingId),
    queryFn: () => api.getBooking(bookingId),
    enabled: !!bookingId,
  })
}
```

### Create Booking Mutation

```typescript
export function useCreateBooking() {
  const queryClient = useQueryClient()
  
  return useMutation({
    mutationFn: (data: CreateBookingInput) => api.createBooking(data),
    onSuccess: (newBooking) => {
      // Invalidate bookings list
      queryClient.invalidateQueries({ queryKey: bookingKeys.lists() })
      // Invalidate space availability
      queryClient.invalidateQueries({ 
        queryKey: spaceKeys.availability(newBooking.spaceId) 
      })
    },
  })
}
```

---

## Query Key Factory

```typescript
// lib/query-keys.ts
export const spaceKeys = {
  all: ['spaces'] as const,
  lists: () => [...spaceKeys.all, 'list'] as const,
  list: (filters?: SpaceFilters) => [...spaceKeys.lists(), filters] as const,
  details: () => [...spaceKeys.all, 'detail'] as const,
  detail: (id: string) => [...spaceKeys.details(), id] as const,
  availability: (id: string) => [...spaceKeys.detail(id), 'availability'] as const,
}

export const bookingKeys = {
  all: ['bookings'] as const,
  lists: () => [...bookingKeys.all, 'list'] as const,
  list: (userId: string, filters?: BookingFilters) => 
    [...bookingKeys.lists(), userId, filters] as const,
  details: () => [...bookingKeys.all, 'detail'] as const,
  detail: (id: string) => [...bookingKeys.details(), id] as const,
}
```

---

## Client State (Zustand)

### UI Store

```typescript
// stores/ui-store.ts
import { create } from 'zustand'

interface UIState {
  sidebarOpen: boolean
  toggleSidebar: () => void
  
  bookingModalOpen: boolean
  bookingModalSpaceId: string | null
  openBookingModal: (spaceId: string) => void
  closeBookingModal: () => void
}

export const useUIStore = create<UIState>((set) => ({
  sidebarOpen: false,
  toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),
  
  bookingModalOpen: false,
  bookingModalSpaceId: null,
  openBookingModal: (spaceId) => set({ 
    bookingModalOpen: true, 
    bookingModalSpaceId: spaceId 
  }),
  closeBookingModal: () => set({ 
    bookingModalOpen: false, 
    bookingModalSpaceId: null 
  }),
}))
```

### Usage

```typescript
function SpaceCard({ space }: { space: Space }) {
  const openBookingModal = useUIStore((s) => s.openBookingModal)
  
  return (
    <Card>
      <h3>{space.name}</h3>
      <Button onClick={() => openBookingModal(space.id)}>
        Book Now
      </Button>
    </Card>
  )
}
```

---

## URL State for Filters

```typescript
'use client'
import { useSearchParams, useRouter } from 'next/navigation'

function BookingFilters() {
  const router = useRouter()
  const searchParams = useSearchParams()
  
  const status = searchParams.get('status') ?? 'all'
  const dateFrom = searchParams.get('from')
  const dateTo = searchParams.get('to')
  
  const setFilter = (key: string, value: string | null) => {
    const params = new URLSearchParams(searchParams)
    if (value) {
      params.set(key, value)
    } else {
      params.delete(key)
    }
    router.push(`?${params.toString()}`)
  }
  
  return (
    <div className="flex gap-4">
      <Select 
        value={status} 
        onChange={(e) => setFilter('status', e.target.value)}
      >
        <option value="all">All</option>
        <option value="upcoming">Upcoming</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </Select>
      
      <DateRangePicker
        from={dateFrom}
        to={dateTo}
        onChange={(from, to) => {
          setFilter('from', from)
          setFilter('to', to)
        }}
      />
    </div>
  )
}
```

---

## Form State (Booking Form)

```typescript
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'

const BookingFormSchema = z.object({
  date: z.date().min(new Date(), 'Date must be in the future'),
  startTime: z.string(),
  duration: z.number().min(1).max(8),
  notes: z.string().optional(),
})

type BookingFormData = z.infer<typeof BookingFormSchema>

function BookingForm({ spaceId }: { spaceId: string }) {
  const createBooking = useCreateBooking()
  
  const form = useForm<BookingFormData>({
    resolver: zodResolver(BookingFormSchema),
    defaultValues: {
      duration: 2,
    },
  })
  
  const onSubmit = async (data: BookingFormData) => {
    await createBooking.mutateAsync({
      spaceId,
      ...data,
    })
  }
  
  return (
    <form onSubmit={form.handleSubmit(onSubmit)}>
      <DatePicker {...form.register('date')} />
      {form.formState.errors.date && (
        <span className="text-red-500">
          {form.formState.errors.date.message}
        </span>
      )}
      
      {/* ... other fields ... */}
      
      <Button type="submit" loading={createBooking.isPending}>
        Book Space
      </Button>
    </form>
  )
}
```

---

## Loading States Pattern

```typescript
function BookingHistory({ userId }: { userId: string }) {
  const { data, isLoading, error, isError } = useBookings(userId)
  
  if (isLoading) return <BookingListSkeleton />
  if (isError) return <ErrorMessage error={error} />
  if (!data?.length) return <EmptyBookings />
  
  return (
    <div className="space-y-4">
      {data.map((booking) => (
        <BookingCard key={booking.id} booking={booking} />
      ))}
    </div>
  )
}
```
